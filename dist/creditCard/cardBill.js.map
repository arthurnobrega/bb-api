{"version":3,"sources":["../../src/creditCard/cardBill.js"],"names":["stringToAmount","string","parseFloat","replace","stringToDate","parts","split","day","month","year","length","Date","parseInt","stringToDateInstallment","date","description","billMonth","installment","match","test","BBCardBill","cardAccountNumber","billId","billDate","transactionsUrl","params","numeroContaCartao","sequencialFatura","dataFatura","tipoExtrato","BASE_ENDPOINT","headers","DEFAULT_HEADERS","cookie","LoginCookie","getGlobal","method","body","querystring","stringify","response","text","json","JSON","parse","conteiner","telas","sessoes","map","s","cabecalho","celulas","slice","type","c","componentes","texto","amount","filter","reduce","transactions","session"],"mappings":"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","file":"cardBill.js","sourcesContent":["import fetch from 'node-fetch';\nimport querystring from 'querystring';\nimport LoginCookie from '../loginCookie';\nimport { BASE_ENDPOINT, DEFAULT_HEADERS } from '../constants';\nimport { treatDescription } from '../helpers';\n\nfunction stringToAmount(string) {\n  return (\n    -1 *\n    parseFloat(\n      string\n        .replace('R$ ', '')\n        .replace('.', '')\n        .replace(',', '.'),\n    )\n  );\n}\n\nfunction stringToDate(string) {\n  const parts = string.split('/');\n  const day = parts[0];\n  const month = parts[1];\n  let year = parts[2];\n\n  if (year.length === 2) {\n    year = `20${year}`;\n  }\n\n  return new Date(year, parseInt(month, 10) - 1, day);\n}\n\nfunction stringToDateInstallment({ date, description, billMonth }) {\n  const installment = description.match(/.*(\\d{2,3})\\/(\\d{2,3}).*/)[1];\n  const parts = date.split('/');\n  const day = parts[0];\n  let month = parseInt(parts[1], 10) + parseInt(installment, 10) - 1;\n  const year = `20${parts[2]}`;\n\n  if (/^ANTEC /.test(description)) {\n    month = parseInt(billMonth, 10) - 1;\n  }\n\n  return new Date(year, parseInt(month, 10) - 1, day);\n}\n\nexport default class BBCardBill {\n  constructor({ cardAccountNumber, billId, billDate }) {\n    this.cardAccountNumber = cardAccountNumber;\n    this.billId = billId;\n    this.billDate = billDate;\n  }\n\n  async getTransactions() {\n    const transactionsUrl = 'tela/ExtratoFatura/extrato';\n\n    const params = {\n      numeroContaCartao: this.cardAccountNumber,\n      sequencialFatura: this.billId,\n      dataFatura: this.billDate,\n      tipoExtrato: 'F',\n    };\n\n    const response = await fetch(`${BASE_ENDPOINT}${transactionsUrl}`, {\n      headers: {\n        ...DEFAULT_HEADERS,\n        cookie: LoginCookie.getGlobal(),\n      },\n      method: 'POST',\n      body: querystring.stringify(params),\n    });\n\n    const text = await response.text();\n    const json = JSON.parse(text);\n\n    return json.conteiner.telas[0].sessoes\n      .map(s => {\n        if (s.cabecalho === '    Pagamentos') {\n          return s.celulas.slice(1).map(c => ({\n            type: 'payment',\n            date: stringToDate(c.componentes[0].componentes[0].texto),\n            description: treatDescription(\n              c.componentes[1].componentes[0].texto,\n            ),\n            amount: stringToAmount(c.componentes[2].componentes[0].texto),\n          }));\n        }\n\n        if (s.cabecalho === '    Compras a vista') {\n          return s.celulas.slice(1).map(c => ({\n            type: 'atSight',\n            date: stringToDate(c.componentes[0].componentes[0].texto),\n            description: treatDescription(\n              c.componentes[1].componentes[0].texto,\n            ),\n            amount: stringToAmount(c.componentes[2].componentes[0].texto),\n          }));\n        }\n\n        if (s.cabecalho === '    Compras/Pgto Contas Parc') {\n          return s.celulas\n            .slice(2, -2)\n            .filter(c => c.componentes.length === 3)\n            .map(c => ({\n              type: 'installment',\n              date: stringToDateInstallment({\n                description: c.componentes[1].componentes[0].texto,\n                date: c.componentes[0].componentes[0].texto,\n                billMonth: this.billDate.slice(2, 4),\n              }),\n              description: treatDescription(\n                c.componentes[1].componentes[0].texto,\n              ),\n              amount: stringToAmount(c.componentes[2].componentes[0].texto),\n            }));\n        }\n\n        return [];\n      })\n      .reduce((transactions, session) => [...transactions, ...session], []);\n  }\n}\n"]}