{"version":3,"sources":["../../src/creditCard/cardBill.js"],"names":["stringToAmount","string","parseFloat","split","slice","join","replace","stringToDate","parts","day","month","year","length","Date","parseInt","stringToDateInstallment","date","description","billMonth","installment","match","test","BBCardBill","cardAccountNumber","billId","billDate","transactionsUrl","params","numeroContaCartao","sequencialFatura","dataFatura","tipoExtrato","BASE_ENDPOINT","headers","DEFAULT_HEADERS","cookie","LoginCookie","getGlobal","method","body","querystring","stringify","response","text","json","JSON","parse","conteiner","telas","sessoes","map","s","cabecalho","celulas","filter","c","componentes","texto","amount","type","currency","reduce","transactions","session"],"mappings":"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","file":"cardBill.js","sourcesContent":["import fetch from 'node-fetch';\nimport querystring from 'querystring';\nimport LoginCookie from '../loginCookie';\nimport { BASE_ENDPOINT, DEFAULT_HEADERS } from '../constants';\nimport { treatDescription } from '../helpers';\n\nfunction stringToAmount(string) {\n  return (\n    -1 *\n    parseFloat(\n      string\n        .split(' ')\n        .slice(1)\n        .join()\n        .replace('.', '')\n        .replace(',', '.'),\n    )\n  );\n}\n\nfunction stringToDate(string) {\n  const parts = string.split('/');\n  const day = parts[0];\n  const month = parts[1];\n  let year = parts[2];\n\n  if (year.length === 2) {\n    year = `20${year}`;\n  }\n\n  return new Date(year, parseInt(month, 10) - 1, day);\n}\n\nfunction stringToDateInstallment({ date, description, billMonth }) {\n  const installment = description.match(/.*(\\d{2,3})\\/(\\d{2,3}).*/)[1];\n  const parts = date.split('/');\n  const day = parts[0];\n  let month = parseInt(parts[1], 10) + parseInt(installment, 10) - 1;\n  const year = `20${parts[2]}`;\n\n  if (/^ANTEC /.test(description)) {\n    month = parseInt(billMonth, 10) - 1;\n  }\n\n  return new Date(year, parseInt(month, 10) - 1, day);\n}\n\nexport default class BBCardBill {\n  constructor({ cardAccountNumber, billId, billDate }) {\n    this.cardAccountNumber = cardAccountNumber;\n    this.billId = billId;\n    this.billDate = billDate;\n  }\n\n  async getTransactions() {\n    const transactionsUrl = 'tela/ExtratoFatura/extrato';\n\n    const params = {\n      numeroContaCartao: this.cardAccountNumber,\n      sequencialFatura: this.billId,\n      dataFatura: this.billDate,\n      tipoExtrato: 'F',\n    };\n\n    const response = await fetch(`${BASE_ENDPOINT}${transactionsUrl}`, {\n      headers: {\n        ...DEFAULT_HEADERS,\n        cookie: LoginCookie.getGlobal(),\n      },\n      method: 'POST',\n      body: querystring.stringify(params),\n    });\n\n    const text = await response.text();\n    const json = JSON.parse(text);\n\n    return json.conteiner.telas[0].sessoes\n      .map(s => {\n        if (s.cabecalho === '    Pagamentos') {\n          return s.celulas\n            .slice(1)\n            .filter(\n              c =>\n                c.componentes.length === 3 &&\n                c.componentes[0].componentes[0].texto !== '' &&\n                c.componentes[1].componentes[0].texto !== '' &&\n                c.componentes[2].componentes[0].texto !== '',\n            )\n            .map(c => {\n              const date = c.componentes[0].componentes[0].texto;\n              const description = c.componentes[1].componentes[0].texto;\n              const amount = c.componentes[2].componentes[0].texto;\n\n              return {\n                type: 'payment',\n                date: stringToDate(date),\n                description: treatDescription(description),\n                amount: stringToAmount(amount),\n              };\n            });\n        }\n\n        if (s.cabecalho === '    Compras a vista') {\n          return s.celulas\n            .slice(1)\n            .filter(\n              c =>\n                c.componentes.length === 3 &&\n                c.componentes[0].componentes[0].texto !== '' &&\n                c.componentes[1].componentes[0].texto !== '' &&\n                c.componentes[2].componentes[0].texto !== '',\n            )\n            .map(c => {\n              const date = c.componentes[0].componentes[0].texto;\n              const description = c.componentes[1].componentes[0].texto;\n              const amount = c.componentes[2].componentes[0].texto;\n              const currency = amount.split(' ')[0];\n\n              return {\n                type: 'atSight',\n                date: stringToDate(date),\n                description:\n                  currency !== 'R$'\n                    ? treatDescription(description, currency)\n                    : treatDescription(description),\n                amount: stringToAmount(amount),\n              };\n            });\n        }\n\n        if (s.cabecalho === '    Compras/Pgto Contas Parc') {\n          return s.celulas\n            .slice(2, -2)\n            .filter(\n              c =>\n                c.componentes.length === 3 &&\n                c.componentes[0].componentes[0].texto !== '' &&\n                c.componentes[1].componentes[0].texto !== '' &&\n                c.componentes[2].componentes[0].texto !== '',\n            )\n            .map(c => {\n              const date = c.componentes[0].componentes[0].texto;\n              const description = c.componentes[1].componentes[0].texto;\n              const amount = c.componentes[2].componentes[0].texto;\n\n              return {\n                type: 'installment',\n                date: stringToDateInstallment({\n                  description,\n                  date,\n                  billMonth: this.billDate.slice(2, 4),\n                }),\n                description: treatDescription(description),\n                amount: stringToAmount(amount),\n              };\n            });\n        }\n\n        return [];\n      })\n      .reduce((transactions, session) => [...transactions, ...session], []);\n  }\n}\n"]}